


--DROPS

DROP TABLESPACE TBS_DATOS_SUPER
INCLUDING CONTENTS AND DATAFILES;

DROP USER DBA01 CASCADE; 



---CREATE TABLESPACE

CREATE TABLESPACE TBS_DATOS_SUPER
   DATAFILE
      'D:\Databases\oradata2\DF_DATA_SUPER01.DBF' SIZE 97M AUTOEXTEND ON,
      'D:\Databases\oradata2\DF_DATA_SUPER02.DBF' SIZE 97M AUTOEXTEND ON
      DEFAULT STORAGE (INITIAL 5M NEXT 6M PCTINCREASE 0);

--CREATING TABLES
CREATE TABLE SUCURSAL (
    ID_SUCURSAL NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    DISTRITO VARCHAR2(30) NOT NULL,
    CANTON VARCHAR2(30) NOT NULL,
    PROVINCIA VARCHAR2(20) NOT NULL,
    PRIMARY KEY (ID_SUCURSAL)
) TABLESPACE TBS_DATOS_SUPER;

CREATE TABLE EMPLEADO (
    ID_EMPLEADO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    NOMBRE VARCHAR2(30) NOT NULL,
    APELLIDO1 VARCHAR2(30) NOT NULL,
    APELLIDO2 VARCHAR2(30) NOT NULL,
    FECHA_INGRESO DATE NOT NULL,
    DIAS_VACACIONES INT NOT NULL,
    ROLE_EMPLEADO VARCHAR2(50) NOT NULL,
    SALARIO FLOAT(30) NOT NULL,
    ID_SUCURSAL INT NOT NULL,
    PRIMARY KEY (ID_EMPLEADO),
    CONSTRAINT FK_SUCURSAL
    FOREIGN KEY (ID_SUCURSAL)
    REFERENCES SUCURSAL(ID_SUCURSAL)
) TABLESPACE TBS_DATOS_SUPER;

CREATE TABLE ACTIVO (
    ID_ACTIVO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    FECHA_INGRESO DATE NOT NULL,
    CANTIDAD INT NOT NULL,
    ID_SUCURSAL INT NOT NULL,
    DESCRIPCION VARCHAR2(50) NOT NULL,
    PRIMARY KEY (ID_ACTIVO) 
) TABLESPACE TBS_DATOS_SUPER;

CREATE TABLE PROVEEDOR (
    ID_PROVEEDOR NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    CEDULA_JURIDICA VARCHAR2 (30) NOT NULL,
    FECHA_ABASTECIMIENTO DATE NOT NULL,
    STOCK INT NOT NULL,
    NOMBRE VARCHAR2(30) NOT NULL,
    APELLIDO1 VARCHAR2(30) NOT NULL,
    APELLIDO2 VARCHAR2(30) NOT NULL,
    PRIMARY KEY (ID_PROVEEDOR)
) TABLESPACE TBS_DATOS_SUPER;

CREATE TABLE PRODUCTO (
    ID_PRODUCTO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    NOMBRE_PRODUCTO VARCHAR2(30) NOT NULL,
    DESCRIPCION VARCHAR2(20) NOT NULL,
    FECHA_VENCIMIENTO DATE NOT NULL,
    STOCK INT NOT NULL,
    ID_SUCURSAL INT NOT NULL,
    ID_PROVEEDOR INT NOT NULL,
    PRIMARY KEY (ID_PRODUCTO),
    CONSTRAINT FK_SUCURSALP FOREIGN KEY (ID_SUCURSAL) REFERENCES SUCURSAL(ID_SUCURSAL),
    CONSTRAINT FK_PROVEEDORP FOREIGN KEY (ID_PROVEEDOR) REFERENCES PROVEEDOR(ID_PROVEEDOR)
) TABLESPACE TBS_DATOS_SUPER;


CREATE TABLE REPARTIDOR (
    ID_REPARTIDOR NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    NOMBRE_REPARTIDOR VARCHAR2(30) NOT NULL,
    APELLIDO1 VARCHAR2(30) NOT NULL,
    APELLIDO2 VARCHAR2(30) NOT NULL,
    TIPO_VEHICULO VARCHAR2(30) NOT NULL,
    PRIMARY KEY (ID_REPARTIDOR)
) TABLESPACE TBS_DATOS_SUPER;

CREATE TABLE CLIENTE (
    ID_CLIENTE NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    CORREO VARCHAR2(50) NOT NULL,
    DESCUENTO FLOAT NOT NULL,
    TELEFONO NUMERIC(8,0) NOT NULL,
    NOMBRE VARCHAR2(30) NOT NULL,
    APELLIDO1 VARCHAR2(30) NOT NULL,
    APELLIDO2 VARCHAR2(30) NOT NULL,
    PRIMARY KEY (ID_CLIENTE)
) TABLESPACE TBS_DATOS_SUPER;

CREATE TABLE MAESTRO (
    ID_MAESTRO NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    ID_EMPLEADO INT NOT NULL,
    TIPO_VENTA VARCHAR2(30) NOT NULL,
    COMPROBANTE INT NOT NULL,
    FECHA_VENTA DATE NOT NULL,
    TOTAL_VENTA FLOAT NOT NULL,
    TIPO_PAGO VARCHAR2(30) NOT NULL,
    ID_REPARTIDOR INT NOT NULL,
    ID_CLIENTE INT NOT NULL,
    PRIMARY KEY (ID_MAESTRO),
    CONSTRAINT FK_REPARTIDORM FOREIGN KEY (ID_REPARTIDOR) REFERENCES REPARTIDOR(ID_REPARTIDOR),
    CONSTRAINT FK_CLIENTEM FOREIGN KEY (ID_CLIENTE) REFERENCES CLIENTE(ID_CLIENTE)
) TABLESPACE TBS_DATOS_SUPER;

CREATE TABLE DETALLE (
    ID_DETALLE NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    ID_PRODUCTO INT NOT NULL,
    ID_MAESTRO INT NOT NULL,
    CANTIDAD INT NOT NULL,
    IMPUESTO FLOAT NOT NULL,
    SUBTOTAL FLOAT NOT NULL,
    PRECIO_UNITARIO FLOAT NOT NULL,
    PRIMARY KEY (ID_DETALLE),
    CONSTRAINT FK_PRODUCT FOREIGN KEY (ID_PRODUCTO) REFERENCES PRODUCTO(ID_PRODUCTO),
    CONSTRAINT FK_MAESTRO FOREIGN KEY (ID_MAESTRO) REFERENCES MAESTRO(ID_MAESTRO)
) TABLESPACE TBS_DATOS_SUPER;


--Ingresa datos a tabla sucursal

INSERT INTO SUCURSAL (DISTRITO, CANTON, PROVINCIA) 
    VALUES ('Carmen','San jose', 'San jose');

INSERT INTO SUCURSAL (DISTRITO, CANTON, PROVINCIA) 
    VALUES ('Merced','San jose', 'San jose');
    
INSERT INTO SUCURSAL (DISTRITO, CANTON, PROVINCIA) 
    VALUES ('Zapote','San jose', 'San jose');
    
INSERT INTO SUCURSAL (DISTRITO, CANTON, PROVINCIA)  
    VALUES ('Pavas','San jose', 'San jose');

--Ingresa datos a tabla empleado

INSERT INTO EMPLEADO (NOMBRE, APELLIDO1, APELLIDO2, FECHA_INGRESO, DIAS_VACACIONES, ROLE_EMPLEADO, SALARIO, ID_SUCURSAL) 
    VALUES ('Pablo','Gomez', 'Gonzalez', (TO_DATE('2003/05/03 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'5', 'miscelanio', '1400' ,'1');

INSERT INTO EMPLEADO (NOMBRE, APELLIDO1, APELLIDO2, FECHA_INGRESO, DIAS_VACACIONES, ROLE_EMPLEADO, SALARIO, ID_SUCURSAL) 
    VALUES ('Pablo','Gomez', 'Gonzalez', (TO_DATE('2003/05/03 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'5', 'miscelanio', '1400' ,'2');
    
INSERT INTO EMPLEADO (NOMBRE, APELLIDO1, APELLIDO2, FECHA_INGRESO, DIAS_VACACIONES, ROLE_EMPLEADO, SALARIO, ID_SUCURSAL) 
    VALUES ('Pablo','Gomez', 'Gonzalez', (TO_DATE('2003/05/03 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'5', 'miscelanio', '1400' ,'3');
    
INSERT INTO EMPLEADO (NOMBRE, APELLIDO1, APELLIDO2, FECHA_INGRESO, DIAS_VACACIONES, ROLE_EMPLEADO, SALARIO, ID_SUCURSAL) 
    VALUES ('Pablo','Gomez', 'Gonzalez', (TO_DATE('2003/05/03 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'5', 'miscelanio', '1400' ,'4');
    
    
--Ingresa datos a tabla activos 

INSERT INTO ACTIVO (FECHA_INGRESO, CANTIDAD, DESCRIPCION, ID_SUCURSAL)
    VALUES ((TO_DATE('2012/05/03 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'20','Paquetes de azucar','1');

INSERT INTO ACTIVO (FECHA_INGRESO, CANTIDAD, DESCRIPCION, ID_SUCURSAL)
    VALUES ((TO_DATE('2012/05/03 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'18','Arroz Don Pedro','2');

INSERT INTO ACTIVO (FECHA_INGRESO, CANTIDAD, DESCRIPCION, ID_SUCURSAL)
    VALUES ((TO_DATE('2012/05/03 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'15','Cereal Naranitas','3');

INSERT INTO ACTIVO (FECHA_INGRESO, CANTIDAD, DESCRIPCION, ID_SUCURSAL)
    VALUES ((TO_DATE('2012/05/03 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'30','Coca Cola','4'); 


-- Ingresa datos tabla proveedor

INSERT INTO PROVEEDOR (CEDULA_JURIDICA, FECHA_ABASTECIMIENTO, STOCK, NOMBRE, APELLIDO1, APELLIDO2) 
   VALUES ('3-101-271020',(TO_DATE('2020/06/03 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),15,'MARVIN','JIMENEZ','JIMENEZ');

INSERT INTO PROVEEDOR (CEDULA_JURIDICA, FECHA_ABASTECIMIENTO, STOCK, NOMBRE, APELLIDO1, APELLIDO2) 
   VALUES ('3-101-281132',(TO_DATE('2020/06/03 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'11','JOSE','ZELEDON','RODRIGUEZ');

INSERT INTO PROVEEDOR (CEDULA_JURIDICA, FECHA_ABASTECIMIENTO, STOCK, NOMBRE, APELLIDO1, APELLIDO2) 
   VALUES ('3-101-293344',(TO_DATE('2020/06/03 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'20','DANIA','ROSALES','AMADOR');

INSERT INTO PROVEEDOR (CEDULA_JURIDICA, FECHA_ABASTECIMIENTO, STOCK, NOMBRE, APELLIDO1, APELLIDO2) 
   VALUES ('3-101-302514',(TO_DATE('2020/06/03 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'16','JORGE','RODRIGUEZ','MARIN');

-- Ingresa datos tabla PRODUCTO

INSERT INTO PRODUCTO (NOMBRE_PRODUCTO, DESCRIPCION, FECHA_VENCIMIENTO, STOCK, ID_SUCURSAL, ID_PROVEEDOR)
    VALUES ('Cafe 1820','Peso 250g',(TO_DATE('2012/05/03 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'20', 1, 1);  

INSERT INTO PRODUCTO (NOMBRE_PRODUCTO, DESCRIPCION, FECHA_VENCIMIENTO, STOCK, ID_SUCURSAL, ID_PROVEEDOR)
    VALUES ('Arroz Tio Pelon 98%','Peso 1.8kg',(TO_DATE('2012/05/03 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'15',2,2);  

INSERT INTO PRODUCTO (NOMBRE_PRODUCTO, DESCRIPCION, FECHA_VENCIMIENTO, STOCK, ID_SUCURSAL, ID_PROVEEDOR)
    VALUES ('Frijoles Rojos Tio Pelon','Peso 800g',(TO_DATE('2012/05/03 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'20',3,3); 

INSERT INTO PRODUCTO (NOMBRE_PRODUCTO, DESCRIPCION, FECHA_VENCIMIENTO, STOCK, ID_SUCURSAL, ID_PROVEEDOR)
    VALUES ('Azucar Morena Zukra','Peso 2kilos',(TO_DATE('2012/05/03 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'30',4,4);
    
    
-- Ingresar datos tabla REPARTIDOR

INSERT INTO REPARTIDOR (NOMBRE_REPARTIDOR, APELLIDO1, APELLIDO2, TIPO_VEHICULO)
    VALUES ('Jose Luis','Vega','Vega','Pick Up');

INSERT INTO REPARTIDOR (NOMBRE_REPARTIDOR, APELLIDO1, APELLIDO2, TIPO_VEHICULO)
    VALUES ('Ana Paula','Rodriguez','Solano','Moto'); 

INSERT INTO REPARTIDOR (NOMBRE_REPARTIDOR, APELLIDO1, APELLIDO2, TIPO_VEHICULO)
    VALUES ('Daniel','Ulate','Ulate','Bicicleta');

INSERT INTO REPARTIDOR (NOMBRE_REPARTIDOR, APELLIDO1, APELLIDO2, TIPO_VEHICULO)
    VALUES ('Felipe','Ortega','Campos','Pick Up');

-- Ingresar datos tabla CLIENTE

INSERT INTO CLIENTE (CORREO, DESCUENTO, TELEFONO, NOMBRE, APELLIDO1, APELLIDO2)
    VALUES ('lucas124@gmail.com','5','77889997','Lucas','Mendez','Mendez');    
    
INSERT INTO CLIENTE (CORREO, DESCUENTO, TELEFONO, NOMBRE, APELLIDO1, APELLIDO2)
    VALUES ('RoxyGrillo@gmail.com','10','75496968','Roxy','Grillo','Vega');    

INSERT INTO CLIENTE (CORREO, DESCUENTO, TELEFONO, NOMBRE, APELLIDO1, APELLIDO2)
    VALUES ('Da1992@gmail.com','10','84579854','Daniel','Campos','Campos');    

INSERT INTO CLIENTE ( CORREO, DESCUENTO, TELEFONO, NOMBRE, APELLIDO1, APELLIDO2)
    VALUES ('Gabriel_785@gmail.com','15','87964569','Gabriel','Ramos','Rodriguez');   
   
-- Ingresar datos tabla MAESTRO

INSERT INTO MAESTRO (ID_EMPLEADO, TIPO_VENTA, COMPROBANTE, FECHA_VENTA, TOTAL_VENTA, TIPO_PAGO, ID_REPARTIDOR, ID_CLIENTE)
    VALUES (1,'En linea','102365',(TO_DATE('2022/07/12 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'5500','Efectivo','1','1');

INSERT INTO MAESTRO (ID_EMPLEADO, TIPO_VENTA, COMPROBANTE, FECHA_VENTA, TOTAL_VENTA, TIPO_PAGO, ID_REPARTIDOR, ID_CLIENTE)
    VALUES (2,'En linea','102365',(TO_DATE('2022/07/12 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'5500','Efectivo','1','1');

INSERT INTO MAESTRO (ID_EMPLEADO, TIPO_VENTA, COMPROBANTE, FECHA_VENTA, TOTAL_VENTA, TIPO_PAGO, ID_REPARTIDOR, ID_CLIENTE)
    VALUES (3,'En persona','104558',(TO_DATE('2022/07/12 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'10500','Tarjeta','3','3');

INSERT INTO MAESTRO (ID_EMPLEADO, TIPO_VENTA, COMPROBANTE, FECHA_VENTA, TOTAL_VENTA, TIPO_PAGO, ID_REPARTIDOR, ID_CLIENTE)
    VALUES (4,'En persona','101998',(TO_DATE('2022/07/12 00:00:00', 'yyyy/mm/dd hh24:mi:ss')),'8505','Efectivo','3','4');

-- Ingresar datos tabla DETALLE


INSERT INTO DETALLE (ID_PRODUCTO,ID_MAESTRO, CANTIDAD, IMPUESTO, SUBTOTAL, PRECIO_UNITARIO)
    VALUES (1,1,13,8,600,6005);

INSERT INTO DETALLE (ID_PRODUCTO,ID_MAESTRO, CANTIDAD, IMPUESTO, SUBTOTAL, PRECIO_UNITARIO)
    VALUES (1,2,102,1,5500,5550);

INSERT INTO DETALLE (ID_PRODUCTO,ID_MAESTRO, CANTIDAD, IMPUESTO, SUBTOTAL, PRECIO_UNITARIO)
    VALUES (1,3,12,1,800,803);

INSERT INTO DETALLE (ID_PRODUCTO,ID_MAESTRO, CANTIDAD, IMPUESTO, SUBTOTAL, PRECIO_UNITARIO)
    VALUES (1,4,102,1,7000,7300);

INSERT INTO DETALLE (ID_PRODUCTO,ID_MAESTRO, CANTIDAD, IMPUESTO, SUBTOTAL, PRECIO_UNITARIO)
    VALUES (3,1,102,1,7000,7300);




--CREATE TRIGGER, CALCULA SUBTATALES
CREATE OR REPLACE TRIGGER SUBTOTAL_DETALLE
AFTER INSERT ON DETALLE
DECLARE
VIDDETALLE DETALLE.ID_DETALLE%TYPE;
    
BEGIN
    SELECT MAX(ID_DETALLE)INTO VIDDETALLE FROM DETALLE;
    UPDATE  DETALLE  SET SUBTOTAL=DETALLE.CANTIDAD*DETALLE.PRECIO_UNITARIO*DETALLE.IMPUESTO where ID_DETALLE=VIDDETALLE;
END;


--TEST CALCULA SUBTATALES
INSERT INTO DETALLE (ID_PRODUCTO,ID_MAESTRO, CANTIDAD, IMPUESTO, SUBTOTAL, PRECIO_UNITARIO)
    VALUES (3,1,102,1,0,6900);




--CREATE PACKGES
CREATE OR REPLACE PACKAGE PKG_CONTA
IS
    PROCEDURE TOTAL_MAESTRO(IDMAESTRO NUMBER);
    PROCEDURE Reporte_factura(filas OUT SYS_REFCURSOR);
END;
/
CREATE OR REPLACE PACKAGE BODY PKG_CONTA
IS
    PROCEDURE TOTAL_MAESTRO(IDMAESTRO NUMBER)
    IS
    TOTALAUX FLOAT;
    BEGIN
        SELECT SUM(DETALLE.SUBTOTAL) INTO TOTALAUX FROM DETALLE WHERE DETALLE.ID_MAESTRO = IDMAESTRO;
        UPDATE MAESTRO SET TOTAL_VENTA=TOTALAUX WHERE MAESTRO.ID_MAESTRO=IDMAESTRO;
    END;

  
    PROCEDURE Reporte_factura(filas OUT SYS_REFCURSOR) 
        AS BEGIN OPEN filas FOR select maestro.ID_MAESTRO, MAESTRO.ID_EMPLEADO AS CAJERO,maestro.TIPO_VENTA, maestro.COMPROBANTE, maestro.FECHA_VENTA,TIPO_PAGO,PRODUCTO.NOMBRE_PRODUCTO, detalle.ID_PRODUCTO, detalle.CANTIDAD||' Uds', '₡ '|| DETALLE.PRECIO_UNITARIO, DETALLE.IMPUESTO ||'%','₡ '||DETALLE.SUBTOTAL,'₡ '||TOTAL_VENTA 
        from detalle 
            inner join maestro on maestro.ID_MAESTRO=detalle.ID_MAESTRO
            inner join PRODUCTO on detalle.ID_PRODUCTO=PRODUCTO.ID_PRODUCTO;
    END;

END;


--TEST TOTAL_MAESTRO

select * from detalle inner join maestro on maestro.ID_MAESTRO=detalle.ID_MAESTRO;
EXECUTE PKG_CONTA.TOTAL_MAESTRO(2);













